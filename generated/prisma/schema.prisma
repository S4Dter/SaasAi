generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                                                               String                  @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  email                                                            String                  @unique
  name                                                             String
  role                                                             String                  @default("enterprise") // "enterprise", "creator", "admin"
  avatar                                                           String?
  company                                                          String?
  bio                                                              String?
  createdAt                                                        DateTime?               @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt                                                        DateTime?               @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  status                                                           String?                 @default("active") // "active", "suspended", "pending"
  agent_conversions                                                agent_conversions[]
  agent_recommendations_agent_recommendations_creator_idTousers    agent_recommendations[] @relation("agent_recommendations_creator_idTousers")
  agent_recommendations_agent_recommendations_enterprise_idTousers agent_recommendations[] @relation("agent_recommendations_enterprise_idTousers")
  agent_revenue                                                    agent_revenue[]
  agent_views                                                      agent_views[]
  agents                                                           Agent[]                 @relation("CreatedAgents")
  community_post_likes                                             community_post_likes[]
  community_posts                                                  community_posts[]
  contacts_contacts_creator_idTousers                              contacts[]              @relation("contacts_creator_idTousers")
  contacts_contacts_enterprise_idTousers                           contacts[]              @relation("contacts_enterprise_idTousers")
  enterprises                                                      enterprises?
  favorites                                                        favorites[]
  purchased_agents                                                 purchased_agents[]
  admin_activity_log                                               admin_activity_log[]
  agent_reports_reporter                                           agent_reports[]         @relation("agent_reports_reporter")
  agent_reports_admin                                              agent_reports[]         @relation("agent_reports_admin")

  @@index([company(ops: raw("gin_trgm_ops"))], map: "idx_users_company_trgm", type: Gin)
  @@index([name(ops: raw("gin_trgm_ops"))], map: "idx_users_name_trgm", type: Gin)
  @@index([role], map: "idx_users_role")
  @@map("users")
}

model Agent {
  id                    String                  @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name                  String
  slug                  String                  @unique
  description           String?
  short_description     String?
  category              String?
  creatorId             String                  @map("creator_id") @db.Uuid
  pricing               Json
  featured              Boolean?                @default(false)
  logo_url              String?
  integrations          String[]
  demo_url              String?
  demo_video_url        String?
  screenshots           String[]
  createdAt             DateTime?               @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt             DateTime?               @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  status                String                  @default("pending") // "pending", "approved", "rejected", "archived"
  approval_date         DateTime?               @db.Timestamptz(6)
  approved_by           String?                 @db.Uuid
  rejection_reason      String?
  agent_conversions     agent_conversions[]
  agent_recommendations agent_recommendations[]
  agent_revenue         agent_revenue[]
  agent_views           agent_views[]
  creator               User                    @relation("CreatedAgents", fields: [creatorId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  contacts              contacts[]
  favorites             favorites[]
  purchased_agents      purchased_agents[]
  agent_reports         agent_reports[]

  @@index([category], map: "idx_agents_category")
  @@index([creatorId], map: "idx_agents_creator_id")
  @@index([description(ops: raw("gin_trgm_ops"))], map: "idx_agents_description_trgm", type: Gin)
  @@index([featured], map: "idx_agents_featured")
  @@index([name(ops: raw("gin_trgm_ops"))], map: "idx_agents_name_trgm", type: Gin)
  @@index([status], map: "idx_agents_status")
  @@map("agents")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model agent_conversions {
  id         String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  agent_id   String    @db.Uuid
  creator_id String    @db.Uuid
  count      Int?      @default(0)
  updated_at DateTime? @default(now()) @db.Timestamptz(6)
  agents     Agent     @relation(fields: [agent_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users      User      @relation(fields: [creator_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model agent_recommendations {
  id                                               String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  agent_id                                         String    @db.Uuid
  enterprise_id                                    String    @db.Uuid
  creator_id                                       String    @db.Uuid
  reason                                           String?
  match_score                                      Int?
  created_at                                       DateTime? @default(now()) @db.Timestamptz(6)
  agents                                           Agent     @relation(fields: [agent_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users_agent_recommendations_creator_idTousers    User      @relation("agent_recommendations_creator_idTousers", fields: [creator_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users_agent_recommendations_enterprise_idTousers User      @relation("agent_recommendations_enterprise_idTousers", fields: [enterprise_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model agent_revenue {
  id         String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  agent_id   String    @db.Uuid
  creator_id String    @db.Uuid
  amount     Decimal   @db.Decimal(12, 2)
  currency   String
  updated_at DateTime? @default(now()) @db.Timestamptz(6)
  agents     Agent     @relation(fields: [agent_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users      User      @relation(fields: [creator_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model agent_views {
  id         String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  agent_id   String    @db.Uuid
  creator_id String    @db.Uuid
  count      Int?      @default(0)
  updated_at DateTime? @default(now()) @db.Timestamptz(6)
  agents     Agent     @relation(fields: [agent_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users      User      @relation(fields: [creator_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model community_post_likes {
  id              String          @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  post_id         String          @db.Uuid
  user_id         String          @db.Uuid
  created_at      DateTime?       @default(now()) @db.Timestamptz(6)
  community_posts community_posts @relation(fields: [post_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users           User            @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([post_id, user_id])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model community_posts {
  id                   String                 @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  title                String
  content              String
  user_id              String                 @db.Uuid
  created_at           DateTime?              @default(now()) @db.Timestamptz(6)
  updated_at           DateTime?              @default(now()) @db.Timestamptz(6)
  community_post_likes community_post_likes[]
  users                User                   @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([user_id], map: "idx_community_posts_user_id")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model contacts {
  id                                  String                @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  agent_id                            String                @db.Uuid
  enterprise_id                       String                @db.Uuid
  creator_id                          String                @db.Uuid
  message                             String
  status                              String
  created_at                          DateTime?             @default(now()) @db.Timestamptz(6)
  updated_at                          DateTime?             @default(now()) @db.Timestamptz(6)
  agents                              Agent                 @relation(fields: [agent_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users_contacts_creator_idTousers    User                  @relation("contacts_creator_idTousers", fields: [creator_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users_contacts_enterprise_idTousers User                  @relation("contacts_enterprise_idTousers", fields: [enterprise_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  enterprise_contacts                 enterprise_contacts[]

  @@index([agent_id], map: "idx_contacts_agent_id")
  @@index([creator_id], map: "idx_contacts_creator_id")
  @@index([enterprise_id], map: "idx_contacts_enterprise_id")
}

// Admin-specific tables
model admin_activity_log {
  id          String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  admin_id    String    @db.Uuid
  action      String // "user_update", "agent_approval", "category_create", etc.
  entity_type String // "user", "agent", "category", etc.
  entity_id   String    @db.Uuid
  details     Json?
  created_at  DateTime? @default(now()) @db.Timestamptz(6)
  admin       User      @relation(fields: [admin_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([admin_id], map: "idx_admin_activity_admin_id")
  @@index([entity_type, entity_id], map: "idx_admin_activity_entity")
  @@map("admin_activity_log")
}

model agent_categories {
  id          String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name        String    @unique
  slug        String    @unique
  description String?
  icon        String?
  created_at  DateTime? @default(now()) @db.Timestamptz(6)
  updated_at  DateTime? @default(now()) @updatedAt @db.Timestamptz(6)

  @@map("agent_categories")
}

model agent_reports {
  id          String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  agent_id    String    @db.Uuid
  reporter_id String    @db.Uuid
  reason      String
  description String?
  status      String    @default("pending") // "pending", "reviewed", "dismissed", "actioned"
  admin_notes String?
  resolution  String?
  created_at  DateTime? @default(now()) @db.Timestamptz(6)
  updated_at  DateTime? @default(now()) @updatedAt @db.Timestamptz(6)
  reviewed_by String?   @db.Uuid
  reviewed_at DateTime? @db.Timestamptz(6)
  agent       Agent     @relation(fields: [agent_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  reporter    User      @relation("agent_reports_reporter", fields: [reporter_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  admin       User?     @relation("agent_reports_admin", fields: [reviewed_by], references: [id], onDelete: SetNull, onUpdate: NoAction)

  @@index([agent_id], map: "idx_agent_reports_agent_id")
  @@index([reporter_id], map: "idx_agent_reports_reporter_id")
  @@index([status], map: "idx_agent_reports_status")
  @@map("agent_reports")
}

model system_settings {
  id            String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  setting_key   String    @unique
  setting_value Json
  created_at    DateTime? @default(now()) @db.Timestamptz(6)
  updated_at    DateTime? @default(now()) @updatedAt @db.Timestamptz(6)
  description   String?

  @@map("system_settings")
}

model notification_templates {
  id         String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  type       String    @unique // "agent_approved", "user_suspended", etc.
  subject    String
  body       String
  variables  String[]
  created_at DateTime? @default(now()) @db.Timestamptz(6)
  updated_at DateTime? @default(now()) @updatedAt @db.Timestamptz(6)

  @@map("notification_templates")
}

model debug_logs {
  id         String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  level      String
  message    String
  data       Json?
  created_at DateTime? @default(now()) @db.Timestamptz(6)
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model enterprise_contacts {
  id           String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  contact_id   String    @db.Uuid
  company_size String?
  industry     String?
  budget       Decimal?  @db.Decimal(12, 2)
  timeline     String?
  needs        String?
  created_at   DateTime? @default(now()) @db.Timestamptz(6)
  updated_at   DateTime? @default(now()) @db.Timestamptz(6)
  contacts     contacts  @relation(fields: [contact_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model enterprises {
  id             String    @id @db.Uuid
  location       String?
  size           String?
  industry       String?
  annual_revenue Decimal?  @db.Decimal(15, 2)
  website        String?
  contact_phone  String?
  created_at     DateTime? @default(now()) @db.Timestamptz(6)
  updated_at     DateTime? @default(now()) @db.Timestamptz(6)
  users          User      @relation(fields: [id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model favorites {
  id         String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  user_id    String    @db.Uuid
  agent_id   String    @db.Uuid
  created_at DateTime? @default(now()) @db.Timestamptz(6)
  agents     Agent     @relation(fields: [agent_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users      User      @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([user_id, agent_id])
  @@index([agent_id], map: "idx_favorites_agent_id")
  @@index([user_id], map: "idx_favorites_user_id")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model purchased_agents {
  id            String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  user_id       String    @db.Uuid
  agent_id      String    @db.Uuid
  purchase_date DateTime? @default(now()) @db.Timestamptz(6)
  status        String
  created_at    DateTime? @default(now()) @db.Timestamptz(6)
  agents        Agent     @relation(fields: [agent_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users         User      @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([user_id, agent_id])
  @@index([agent_id], map: "idx_purchased_agents_agent_id")
  @@index([user_id], map: "idx_purchased_agents_user_id")
}
